{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Eyedentity Eyewear{% endblock %}

{% block content %}
<div class="product-page">
    <!-- Hero Section with Image -->
    <section class="product-hero">
        <div class="container-fluid">
            <div class="product-hero-grid">
                <!-- Image Gallery -->
                <div class="gallery-section">
                    <div class="main-gallery">
                        <div class="main-image-container">
                            {% if product.is_on_sale %}
                            <div class="sale-flash">
                                <div class="flash-content">
                                    <span class="flash-percent">{{ product.discount_percentage }}%</span>
                                    <span class="flash-text">OFF</span>
                                </div>
                            </div>
                            {% endif %}
                            <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image">
                        </div>
                        
                        {% if additional_images %}
                        <div class="thumbnail-strip">
                            <button class="thumb-nav prev" onclick="scrollThumbs(-1)">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <div class="thumbnails-container" id="thumbContainer">
                                <img src="{{ product.image.url }}" class="thumb active" onclick="changeImage(this)" alt="{{ product.name }}">
                                {% for img in additional_images %}
                                <img src="{{ img.image.url }}" class="thumb" onclick="changeImage(this)" alt="{{ product.name }}">
                                {% endfor %}
                            </div>
                            <button class="thumb-nav next" onclick="scrollThumbs(1)">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Product Info -->
                <div class="info-section">
                    <div class="info-sticky">
                        <!-- Breadcrumb -->
                        <nav class="product-breadcrumb">
                            <a href="{% url 'home' %}">Home</a>
                            <span>/</span>
                            <a href="{% url 'shop' %}">Shop</a>
                            {% if product.category %}
                            <span>/</span>
                            <a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a>
                            {% endif %}
                        </nav>
                        
                        <!-- Product Code -->
                        <div class="product-code">
                            <i class="bi bi-tag"></i>
                            <span>{{ product.product_code }}</span>
                        </div>
                        
                        <!-- Title -->
                        <h1 class="product-title">{{ product.name }}</h1>
                        
                        <!-- Price Block -->
                        <div class="price-block">
                            <div class="current-price">${{ product.price }}</div>
                            {% if product.old_price %}
                            <div class="price-details">
                                <span class="old-price">${{ product.old_price }}</span>
                                <span class="savings">Save ${{ product.old_price|floatformat:2|add:"-"|add:product.price|floatformat:2 }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Stock Status -->
                        <div class="stock-status">
                            {% if product.stock_quantity <= 5 and product.stock_quantity > 0 %}
                            <div class="status-badge urgent">
                                <i class="bi bi-lightning-fill"></i>
                                <div>
                                    <strong>Only {{ product.stock_quantity }} left in stock</strong>
                                    <span>Order now before it's gone</span>
                                </div>
                            </div>
                            {% elif product.stock_quantity > 5 %}
                            <div class="status-badge success">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>In Stock </span>
                            </div>
                            {% else %}
                            <div class="status-badge unavailable">
                                <i class="bi bi-x-circle-fill"></i>
                                <span>Out of Stock</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Description -->
                        <div class="product-description">
                            <p>{{ product.description }}</p>
                        </div>
                        
                        <!-- Features -->
                        {% if product.features.all %}
                        <div class="features-block">
                            <h3>What Makes It Special</h3>
                            <ul class="features-list">
                                {% for feature in product.features.all %}
                                <li>
                                    <i class="bi bi-check2"></i>
                                    <span>{{ feature.name }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <!-- CTA Block -->
                        <div class="cta-block">
                            {% if product.stock_quantity > 0 %}
                            <a href="{{ product.whatsapp_link }}" target="_blank" class="btn-primary-order">
                                <i class="bi bi-whatsapp"></i>
                                <span>Order via WhatsApp</span>
                            </a>
                            {% else %}
                            <a href="https://wa.me/263784342632?text=Hi!%20When%20will%20{{ product.name }}%20be%20available?" 
                               target="_blank" class="btn-secondary-order">
                                <i class="bi bi-bell"></i>
                                <span>Get Notified</span>
                            </a>
                            {% endif %}
                            
                            <div class="secondary-actions">
                                <button class="action-icon" onclick="shareProduct()">
                                    <i class="bi bi-share"></i>
                                    <span>Share</span>
                                </button>
                                <a href="{{ product.whatsapp_quick_quote }}" target="_blank" class="action-icon">
                                    <i class="bi bi-calculator"></i>
                                    <span>Get Quote</span>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Trust Signals -->
                        <div class="trust-signals">
                            <div class="signal">
                                <i class="bi bi-shield-check"></i>
                                <div>
                                    <strong>100% Authentic</strong>
                                    <span>Guaranteed genuine products</span>
                                </div>
                            </div>
                            <div class="signal">
                                <i class="bi bi-truck"></i>
                                <div>
                                    <strong>Fast Delivery</strong>
                                    <span>1-3 days in Harare</span>
                                </div>
                            </div>
                            <div class="signal">
                                <i class="bi bi-arrow-repeat"></i>
                                <div>
                                    <strong>30-Day Returns</strong>
                                    <span>Easy return policy</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Methods -->
                        <div class="payment-info">
                            <div class="payment-label">We Accept</div>
                            <div class="payment-methods">
                                <div class="method">
                                    <img src="{% static 'images/ecocash.png' %}" alt="EcoCash">
                                </div>
                                <div class="method">
                                    <i class="bi bi-cash-coin"></i>
                                    <span>Cash</span>
                                </div>
                                <div class="method">
                                    <i class="bi bi-bank"></i>
                                    <span>Bank</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Related Products -->
    {% if related_products %}
    <section class="related-products">
        <div class="container">
            <h2 class="section-heading">Complete Your Look</h2>
            <div class="products-carousel">
                {% for related in related_products %}
                <div class="product-item">
                    <a href="{{ related.get_absolute_url }}" class="item-link">
                        <div class="item-image">
                            {% if related.is_on_sale %}
                            <span class="discount-tag">-{{ related.discount_percentage }}%</span>
                            {% endif %}
                            <img src="{{ related.image.url }}" alt="{{ related.name }}">
                            <div class="image-overlay">
                                <span>View Details</span>
                            </div>
                        </div>
                        <div class="item-info">
                            <h3>{{ related.name|truncatewords:5 }}</h3>
                            <div class="item-price">
                                <span class="price">${{ related.price }}</span>
                                {% if related.old_price %}
                                <span class="old">${{ related.old_price }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    <a href="{{ related.whatsapp_link }}" target="_blank" class="quick-order">
                        <i class="bi bi-whatsapp"></i>
                        Order
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</div>

<!-- Mobile Sticky Bar -->
<div class="mobile-sticky-bar">
    <div class="bar-info">
        <div class="bar-price">${{ product.price }}</div>
        <div class="bar-name">{{ product.name|truncatewords:3 }}</div>
    </div>
    <a href="{{ product.whatsapp_link }}" target="_blank" class="bar-cta">
        <i class="bi bi-whatsapp"></i>
        Order Now
    </a>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* ===== PRODUCT PAGE REVAMP ===== */

.product-page {
    background: linear-gradient(180deg, #0a0d12 0%, #0e1116 100%);
    min-height: 100vh;
    padding-bottom: 4rem;
}

/* Hero Section */
.product-hero {
    padding: 2rem 0;
}

.product-hero-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 4rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
}

/* Gallery Section */
.gallery-section {
    position: sticky;
    top: 140px;
    height: fit-content;
}

.main-image-container {
    position: relative;
    background: #161b22;
    border-radius: 24px;
    overflow: hidden;
    border: 1px solid #2a2f3a;
    margin-bottom: 1.5rem;
}

.sale-flash {
    position: absolute;
    top: 2rem;
    right: 2rem;
    z-index: 10;
}

.flash-content {
    background: linear-gradient(135deg, #ff3b30, #ff2d55);
    padding: 1.25rem 1.5rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(255, 45, 85, 0.4);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.flash-percent {
    display: block;
    font-size: 2.5rem;
    font-weight: 900;
    line-height: 1;
    color: white;
}

.flash-text {
    display: block;
    font-size: 0.9rem;
    font-weight: 700;
    color: white;
    margin-top: 0.25rem;
}

.main-image {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
}

/* Thumbnail Strip */
.thumbnail-strip {
    display: flex;
    align-items: center;
    gap: 1rem;
    position: relative;
}

.thumbnails-container {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    flex: 1;
}

.thumbnails-container::-webkit-scrollbar {
    display: none;
}

.thumb {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 12px;
    border: 2px solid #2a2f3a;
    cursor: pointer;
    transition: all 0.3s;
    flex-shrink: 0;
}

.thumb:hover {
    border-color: #38bdf8;
    transform: translateY(-4px);
}

.thumb.active {
    border-color: #38bdf8;
    box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.2);
}

.thumb-nav {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #1c2128;
    border: 1px solid #2a2f3a;
    color: #9ca3af;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.thumb-nav:hover {
    background: #2a2f3a;
    color: #38bdf8;
    border-color: #38bdf8;
}

/* Info Section */
.info-section {
    padding-top: 1rem;
}

.info-sticky {
    position: sticky;
    top: 140px;
}

.product-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.product-breadcrumb a {
    color: #9ca3af;
    text-decoration: none;
    transition: color 0.2s;
}

.product-breadcrumb a:hover {
    color: #38bdf8;
}

.product-breadcrumb span {
    color: #6b7280;
}

.product-code {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(56, 189, 248, 0.1);
    border: 1px solid rgba(56, 189, 248, 0.3);
    border-radius: 8px;
    color: #38bdf8;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.product-title {
    font-size: 2.75rem;
    font-weight: 800;
    line-height: 1.1;
    color: #ffffff;
    margin-bottom: 1.5rem;
    letter-spacing: -0.02em;
}

/* Price Block */
.price-block {
    margin-bottom: 2rem;
}

.current-price {
    font-size: 3.5rem;
    font-weight: 900;
    background: linear-gradient(135deg, #22c55e, #10b981);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.price-details {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.old-price {
    font-size: 1.5rem;
    color: #6b7280;
    text-decoration: line-through;
}

.savings {
    padding: 0.5rem 1rem;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 8px;
    color: #22c55e;
    font-weight: 700;
    font-size: 0.9rem;
}

/* Stock Status */
.stock-status {
    margin-bottom: 2rem;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    border-radius: 16px;
    border: 1px solid;
}

.status-badge.urgent {
    background: rgba(255, 45, 85, 0.1);
    border-color: rgba(255, 45, 85, 0.3);
}

.status-badge.urgent i {
    color: #ff2d55;
    font-size: 1.75rem;
}

.status-badge.urgent strong {
    display: block;
    color: #ff2d55;
    font-size: 1.05rem;
    margin-bottom: 0.25rem;
}

.status-badge.urgent span {
    color: #ff9aa2;
    font-size: 0.9rem;
}

.status-badge.success {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.3);
}

.status-badge.success i {
    color: #22c55e;
    font-size: 1.5rem;
}

.status-badge.success span {
    color: #22c55e;
    font-weight: 600;
}

.status-badge.unavailable {
    background: rgba(107, 114, 128, 0.1);
    border-color: rgba(107, 114, 128, 0.3);
}

.status-badge.unavailable i {
    color: #6b7280;
    font-size: 1.5rem;
}

.status-badge.unavailable span {
    color: #9ca3af;
    font-weight: 600;
}

/* Description */
.product-description {
    margin-bottom: 2rem;
}

.product-description p {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #d1d5db;
}

/* Features */
.features-block {
    margin-bottom: 2.5rem;
}

.features-block h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 1rem;
}

.features-list {
    list-style: none;
    display: grid;
    gap: 0.75rem;
}

.features-list li {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #d1d5db;
    font-size: 1rem;
}

.features-list i {
    color: #38bdf8;
    font-size: 1.25rem;
    flex-shrink: 0;
}

/* CTA Block */
.cta-block {
    margin-bottom: 2.5rem;
}

.btn-primary-order,
.btn-secondary-order {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
    padding: 1.5rem;
    border-radius: 16px;
    font-size: 1.25rem;
    font-weight: 700;
    text-decoration: none;
    transition: all 0.3s;
    margin-bottom: 1rem;
}

.btn-primary-order {
    background: linear-gradient(135deg, #25d366, #20c157);
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(37, 211, 102, 0.3);
}

.btn-primary-order:hover {
    background: linear-gradient(135deg, #20c157, #1ea952);
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(37, 211, 102, 0.4);
    color: white;
}

.btn-primary-order i {
    font-size: 1.75rem;
}

.btn-secondary-order {
    background: #1c2128;
    border: 2px solid #2a2f3a;
    color: #9ca3af;
}

.btn-secondary-order:hover {
    border-color: #38bdf8;
    color: #38bdf8;
    background: #2a2f3a;
}

.secondary-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

.action-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: #1c2128;
    border: 1px solid #2a2f3a;
    border-radius: 12px;
    color: #9ca3af;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.action-icon:hover {
    background: #2a2f3a;
    border-color: #38bdf8;
    color: #38bdf8;
}

.action-icon i {
    font-size: 1.5rem;
}

/* Trust Signals */
.trust-signals {
    display: grid;
    gap: 1rem;
    margin-bottom: 2rem;
}

.signal {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #161b22;
    border: 1px solid #2a2f3a;
    border-radius: 12px;
}

.signal i {
    font-size: 2rem;
    color: #38bdf8;
    flex-shrink: 0;
}

.signal strong {
    display: block;
    color: #ffffff;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}

.signal span {
    display: block;
    color: #9ca3af;
    font-size: 0.85rem;
}

/* Payment Info */
.payment-info {
    background: #161b22;
    border: 1px solid #2a2f3a;
    border-radius: 16px;
    padding: 1.5rem;
}

.payment-label {
    color: #9ca3af;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.payment-methods {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.method {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: #1c2128;
    border: 1px solid #2a2f3a;
    border-radius: 10px;
}

.method img {
    height: 24px;
}

.method i {
    font-size: 1.5rem;
    color: #38bdf8;
}

.method span {
    color: #d1d5db;
    font-size: 0.85rem;
    font-weight: 600;
}

/* Related Products */
.related-products {
    padding: 4rem 0;
    background: #0e1116;
}

.section-heading {
    font-size: 2.5rem;
    font-weight: 800;
    text-align: center;
    color: #ffffff;
    margin-bottom: 3rem;
}

.products-carousel {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
}

.product-item {
    background: #161b22;
    border: 1px solid #2a2f3a;
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.3s;
}

.product-item:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    border-color: #38bdf8;
}

.item-link {
    text-decoration: none;
    color: inherit;
}

.item-image {
    position: relative;
    overflow: hidden;
    aspect-ratio: 4/3;
}

.discount-tag {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #ff2d55;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 700;
    z-index: 2;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s;
}

.product-item:hover .item-image img {
    transform: scale(1.1);
}

.image-overlay {
    position: absolute;
    inset: 0;
    background: rgba(14, 17, 22, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.product-item:hover .image-overlay {
    opacity: 1;
}

.image-overlay span {
    color: #38bdf8;
    font-weight: 600;
    font-size: 1.1rem;
}

.item-info {
    padding: 1.5rem;
}

.item-info h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 0.75rem;
}

.item-price {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.item-price .price {
    font-size: 1.5rem;
    font-weight: 800;
    color: #22c55e;
}

.item-price .old {
    font-size: 1rem;
    color: #6b7280;
    text-decoration: line-through;
}

.quick-order {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #25d366, #20c157);
    color: white;
    text-decoration: none;
    font-weight: 700;
    transition: all 0.3s;
}

.quick-order:hover {
    background: linear-gradient(135deg, #20c157, #1ea952);
    color: white;
}

/* Mobile Sticky Bar */
.mobile-sticky-bar {
    display: none;
}

/* Responsive */
@media (max-width: 1024px) {
    .product-hero-grid {
        grid-template-columns: 1fr;
        gap: 3rem;
    }
    
    .gallery-section,
    .info-sticky {
        position: static;
    }
    
    .product-title {
        font-size: 2.25rem;
    }
    
    .current-price {
        font-size: 2.75rem;
    }
    
    .mobile-sticky-bar {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #161b22;
        border-top: 1px solid #2a2f3a;
        padding: 1rem 1.5rem;
        align-items: center;
        justify-content: space-between;
        z-index: 1000;
        box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
    }
    
    .bar-info {
        flex: 1;
    }
    
    .bar-price {
        font-size: 1.75rem;
        font-weight: 800;
        color: #22c55e;
        line-height: 1;
        margin-bottom: 0.25rem;
    }
    
    .bar-name {
        font-size: 0.85rem;
        color: #9ca3af;
    }
    
    .bar-cta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #25d366, #20c157);
        color: white;
        text-decoration: none;
        font-weight: 700;
        border-radius: 12px;
        white-space: nowrap;
    }
    
    .bar-cta i {
        font-size: 1.25rem;
    }
    
    .product-page {
        padding-bottom: 6rem;
    }
}

@media (max-width: 640px) {
    .product-hero-grid {
        padding: 0 1rem;
    }
    
    .product-title {
        font-size: 1.75rem;
    }
    
    .current-price {
        font-size: 2.25rem;
    }
    
    .thumbnails-container {
        gap: 0.5rem;
    }
    
    .thumb {
        width: 70px;
        height: 70px;
    }
    
    .products-carousel {
        grid-template-columns: 1fr;
    }
    
    .bar-cta {
        padding: 0.875rem 1.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function changeImage(thumb) {
    document.getElementById('mainImage').src = thumb.src;
    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
}

function scrollThumbs(direction) {
    const container = document.getElementById('thumbContainer');
    const scrollAmount = 120;
    container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
    });
}

function shareProduct() {
    if (navigator.share) {
        navigator.share({
            title: '{{ product.name }}',
            text: '{{ product.description|truncatewords:15 }}',
            url: window.location.href
        }).catch(() => {});
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
        });
    }
}

// Image zoom on hover (desktop only)
if (window.innerWidth > 1024) {
    const mainImage = document.getElementById('mainImage');
    const container = mainImage.parentElement;
    
    container.addEventListener('mousemove', (e) => {
        const rect = container.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        mainImage.style.transformOrigin = `${x}% ${y}%`;
        mainImage.style.transform = 'scale(1.5)';
    });
    
    container.addEventListener('mouseleave', () => {
        mainImage.style.transform = 'scale(1)';
    });
}
</script>
{% endblock %}